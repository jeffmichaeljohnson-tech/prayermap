name: Android Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type (apk, aab, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - apk
          - aab
          - both

jobs:
  build:
    name: Build Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build
        env:
          NODE_ENV: production

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Decode keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > /home/runner/keystore.jks
          echo "Keystore decoded successfully"

      - name: Create keystore.properties
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          cat > android/keystore.properties << EOF
          storeFile=/home/runner/keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
          echo "keystore.properties created"

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build release APK
        if: ${{ github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event_name == 'push' }}
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace
          echo "APK built successfully"

      - name: Build release AAB
        if: ${{ github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both' || github.event_name == 'push' }}
        run: |
          cd android
          ./gradlew bundleRelease --stacktrace
          echo "AAB built successfully"

      - name: List build outputs
        run: |
          echo "=== APK files ==="
          find android/app/build/outputs/apk -type f -name "*.apk" || echo "No APK files found"
          echo ""
          echo "=== AAB files ==="
          find android/app/build/outputs/bundle -type f -name "*.aab" || echo "No AAB files found"

      - name: Upload APK artifact
        if: ${{ github.event.inputs.build_type == 'apk' || github.event.inputs.build_type == 'both' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error
          retention-days: 30

      - name: Upload AAB artifact
        if: ${{ github.event.inputs.build_type == 'aab' || github.event.inputs.build_type == 'both' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 30

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cat > release-notes.md << EOF
          # PrayerMap Android Release ${{ steps.version.outputs.version }}

          ## Build Information
          - **Version**: ${{ steps.version.outputs.version }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref }}

          ## Artifacts
          - \`app-release.apk\`: For testing and direct installation
          - \`app-release.aab\`: For Google Play Store upload

          ## Installation Instructions
          ### APK (Testing)
          1. Download \`app-release.apk\`
          2. Enable "Install from Unknown Sources" on your Android device
          3. Install the APK

          ### AAB (Play Store)
          1. Download \`app-release.aab\`
          2. Upload to Google Play Console
          3. Create a new release

          ## Notes
          - This is a production-signed release build
          - Minimum Android version: API 24 (Android 7.0)
          - Target Android version: API 34 (Android 14)
          EOF

      - name: Upload release notes
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
          retention-days: 90

      - name: Cleanup keystore
        if: always()
        run: |
          rm -f /home/runner/keystore.jks
          rm -f android/keystore.properties
          echo "Cleanup completed"
