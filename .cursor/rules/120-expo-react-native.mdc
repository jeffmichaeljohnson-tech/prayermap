---
description: Expo + React Native mobile development patterns (Phase 2+)
globs: ["apps/mobile/**/*", "packages/**/*", "*.native.tsx", "*.native.ts"]
alwaysApply: false
---

# Expo + React Native (Phase 2)

## Strategy Decision (2025-12-08)
**SKIP CAPACITOR** - Go directly to Expo + React Native for full native capabilities.

**Why:** Capacitor WebView limitations block "wow" animations and full notifications. React Native provides native performance, full push notifications, 60 FPS animations.

**Reference:** `docs/MOBILE-STRATEGY.md`, `docs/ARCHITECTURE.md` (ADR-011)

---

## Tech Stack

| Layer | Technology |
|-------|------------|
| Framework | Expo SDK 52+ |
| Navigation | Expo Router |
| Styling | NativeWind 4 (Tailwind for RN) |
| Animations | Reanimated 4 + Skia |
| Maps | @rnmapbox/maps |
| State | TanStack Query + Zustand |
| Backend | Supabase (unchanged) |

---

## Project Structure (Monorepo)

```
prayermap/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îî‚îÄ‚îÄ mobile/           # Expo app (iOS, Android, Web)
‚îÇ       ‚îú‚îÄ‚îÄ app/          # Expo Router screens
‚îÇ       ‚îú‚îÄ‚îÄ components/   # UI components
‚îÇ       ‚îî‚îÄ‚îÄ features/     # Feature-Sliced Design
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ core/             # Shared business logic
‚îÇ   ‚îú‚îÄ‚îÄ api/              # Supabase client
‚îÇ   ‚îî‚îÄ‚îÄ ui/               # Shared components
‚îî‚îÄ‚îÄ supabase/             # Database (unchanged)
```

---

## NativeWind Styling

```tsx
// ‚úÖ Same Tailwind classes work in React Native
import { View, Text } from 'react-native';

export function PrayerCard({ prayer }) {
  return (
    <View className="bg-white/80 rounded-xl p-4 backdrop-blur-lg">
      <Text className="text-lg font-semibold text-gray-800">
        {prayer.title}
      </Text>
    </View>
  );
}
```

**Note:** Some web-only classes need alternatives:
- `hover:` ‚Üí Use `Pressable` with `onPressIn`/`onPressOut`
- `cursor-pointer` ‚Üí Not needed in RN
- `backdrop-filter` ‚Üí Use `expo-blur`

---

## Animations (Reanimated)

```tsx
// ‚úÖ Reanimated pattern (replaces Framer Motion)
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withSpring,
  withRepeat,
  withSequence,
  withTiming
} from 'react-native-reanimated';

export function FloatingMarker() {
  const translateY = useSharedValue(0);

  useEffect(() => {
    translateY.value = withRepeat(
      withSequence(
        withTiming(-5, { duration: 1000 }),
        withTiming(0, { duration: 1000 })
      ),
      -1,  // infinite
      true // reverse
    );
  }, []);

  const animatedStyle = useAnimatedStyle(() => ({
    transform: [{ translateY: translateY.value }],
  }));

  return (
    <Animated.View style={animatedStyle}>
      <Text className="text-4xl">üôè</Text>
    </Animated.View>
  );
}
```

---

## Maps (@rnmapbox/maps)

```tsx
import MapboxGL from '@rnmapbox/maps';

MapboxGL.setAccessToken(process.env.EXPO_PUBLIC_MAPBOX_TOKEN);

export function PrayerMap() {
  return (
    <MapboxGL.MapView
      style={{ flex: 1 }}
      styleURL="mapbox://styles/mapbox/light-v11"
    >
      <MapboxGL.Camera
        centerCoordinate={[lng, lat]}
        zoomLevel={12}
      />

      {/* Prayer markers */}
      <MapboxGL.MarkerView coordinate={[lng, lat]}>
        <PrayerMarker prayer={prayer} />
      </MapboxGL.MarkerView>
    </MapboxGL.MapView>
  );
}
```

---

## Memorial Lines (Skia)

```tsx
import { Canvas, Path, LinearGradient, vec } from '@shopify/react-native-skia';

export function MemorialLine({ from, to }) {
  const path = useMemo(() => {
    const p = Skia.Path.Make();
    const controlY = Math.min(from.y, to.y) - 80;
    p.moveTo(from.x, from.y);
    p.quadTo((from.x + to.x) / 2, controlY, to.x, to.y);
    return p;
  }, [from, to]);

  return (
    <Canvas style={{ flex: 1 }}>
      <Path path={path} style="stroke" strokeWidth={2}>
        <LinearGradient
          start={vec(from.x, from.y)}
          end={vec(to.x, to.y)}
          colors={['#FFD700', '#70B8E8', '#A78BFA']}
        />
      </Path>
    </Canvas>
  );
}
```

---

## Push Notifications (Expo)

```tsx
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';

export async function registerForPushNotifications() {
  if (!Device.isDevice) {
    console.log('Push notifications require physical device');
    return null;
  }

  const { status } = await Notifications.requestPermissionsAsync();
  if (status !== 'granted') {
    return null;
  }

  const token = await Notifications.getExpoPushTokenAsync({
    projectId: 'your-project-id',
  });

  return token.data;
}

// Handle notification received
Notifications.addNotificationReceivedListener(notification => {
  console.log('Notification received:', notification);
});
```

---

## Platform-Specific Code

```tsx
// Use .native.tsx for RN-specific, .web.tsx for web-specific
// components/Button.tsx       ‚Üí shared
// components/Button.native.tsx ‚Üí RN override
// components/Button.web.tsx    ‚Üí Web override

// Or use Platform API
import { Platform } from 'react-native';

const isWeb = Platform.OS === 'web';
const isIOS = Platform.OS === 'ios';
const isAndroid = Platform.OS === 'android';
```

---

## Build Commands

```bash
# Development
npx expo start

# iOS Simulator
npx expo run:ios

# Android Emulator
npx expo run:android

# Web
npx expo start --web

# Build for TestFlight
eas build --platform ios --profile preview

# Build for Play Store
eas build --platform android --profile preview

# OTA Update (no app store review)
eas update --branch production
```

---

## What NOT to Do

- ‚ùå Don't use Capacitor patterns
- ‚ùå Don't use `react-dom` imports in shared code
- ‚ùå Don't use CSS-in-JS (styled-components) - use NativeWind
- ‚ùå Don't use `framer-motion` - use Reanimated
- ‚ùå Don't use `mapbox-gl` directly - use `@rnmapbox/maps`

---

## Related Documentation

- `docs/MOBILE-STRATEGY.md` - Full mobile strategy
- `docs/ANIMATION-SPEC.md` - Animation preservation guide
- `docs/ARCHITECTURE.md` - ADR-011 through ADR-014
