---
description: Mapbox GL JS integration patterns
globs: ["**/*map*", "**/*Map*", "src/components/map/**/*"]
alwaysApply: false
---

# Mapbox GL JS Integration

## Setup
```typescript
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

mapboxgl.accessToken = import.meta.env.VITE_MAPBOX_TOKEN;

const map = new mapboxgl.Map({
  container: mapRef.current!,
  style: 'mapbox://styles/mapbox/light-v11',
  center: [lng, lat],
  zoom: 12,
});
```

## Markers
```typescript
// Custom marker
const marker = new mapboxgl.Marker({
  element: customElement,
  anchor: 'bottom',
})
  .setLngLat([lng, lat])
  .addTo(map);

// With popup
marker.setPopup(
  new mapboxgl.Popup({ offset: 25 })
    .setHTML('<h3>Prayer Request</h3>')
);
```

## Memorial Lines (CRITICAL)
Memorial lines are ETERNAL - they never expire or get deleted.

```typescript
// Add line source
map.addSource('memorial-lines', {
  type: 'geojson',
  data: {
    type: 'FeatureCollection',
    features: memorialLines.map(line => ({
      type: 'Feature',
      geometry: {
        type: 'LineString',
        coordinates: [
          [line.from_lng, line.from_lat],
          [line.to_lng, line.to_lat]
        ]
      },
      properties: { id: line.id }
    }))
  }
});

// Add line layer with gradient
map.addLayer({
  id: 'memorial-lines-layer',
  type: 'line',
  source: 'memorial-lines',
  paint: {
    'line-color': '#F5D76E',
    'line-width': 2,
    'line-opacity': 0.8,
  }
});
```

## Event Handlers
```typescript
map.on('click', 'prayers-layer', (e) => {
  const prayer = e.features?.[0];
  if (prayer) {
    openPrayerModal(prayer.properties.id);
  }
});

map.on('mouseenter', 'prayers-layer', () => {
  map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'prayers-layer', () => {
  map.getCanvas().style.cursor = '';
});
```

## Geolocation
```typescript
// Request user location
navigator.geolocation.getCurrentPosition(
  (pos) => {
    const { latitude, longitude } = pos.coords;
    map.flyTo({
      center: [longitude, latitude],
      zoom: 14,
      duration: 2000,
    });
  },
  (error) => {
    console.error('Geolocation error:', error);
  }
);
```

## Performance Tips
- Use clustering for many markers
- Lazy load map on mobile
- Debounce map events
- Use vector tiles for large datasets
